<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #050507; --accent: #ff3b30; --gold: #f1c40f; --text: #fff; --glass: rgba(255,255,255,0.05); }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .btn-main { background: var(--accent); color: #fff; }
        .btn-glass { background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-gold { background: var(--gold); color: #000; }
        #game-chat { flex-grow: 1; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--glass); }
        .msg { font-size: 14px; margin-bottom: 5px; }
        .msg.sys { color: var(--gold); font-style: italic; }
        input { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; width: 100%; box-sizing: border-box; margin-bottom: 10px; outline: none; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1 style="text-align:center; color:var(--accent)">MAFIA</h1>
        <div style="margin-top:auto">
            <button class="btn btn-main" onclick="startConnect('online')">–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</button>
            <button class="btn btn-glass" onclick="showScreen('screen-setup')">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button class="btn btn-gold" onclick="showScreen('screen-shop')">–ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
            <button class="btn btn-glass" onclick="showScreen('screen-settings')">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2>–ù–ò–ö–ù–ï–ô–ú</h2>
        <input type="text" id="name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è...">
        <button class="btn btn-main" onclick="saveName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="screen-shop" class="screen">
        <h2>–ú–ê–ì–ê–ó–ò–ù</h2>
        <div style="border: 1px solid var(--gold); padding: 20px; border-radius: 15px; text-align: center">
            <h3 style="color:var(--gold)">VIP –°–¢–ê–¢–£–° üëë</h3>
            <p>–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫ + –ö–æ—Ä–æ–Ω–∞</p>
            <button class="btn btn-gold" onclick="buyVip()">500 ‚≠ê</button>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h1 id="code-display" style="text-align:center; font-size:40px; color:var(--gold)">----</h1>
        <h2 id="count-display" style="text-align:center">1 / 2</h2>
        <button class="btn btn-glass" style="margin-top:auto" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; font-size:12px">
            <b id="role-tag">ROLE: ???</b>
            <b id="phase-tag" style="color:var(--accent)">NIGHT</b>
        </div>
        <div id="action-pannel" style="background:var(--glass); padding:10px; border-radius:10px; margin:10px 0">
            <b id="action-hint">–í–∞—à —Ö–æ–¥:</b>
            <div id="action-list"></div>
        </div>
        <div id="game-chat"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="msg-input" placeholder="–ß–∞—Ç..." style="margin:0">
            <button class="btn-main" style="width:60px; margin:0" onclick="sendMsg()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SERVER_URL = "https://mafia-game-skw7.onrender.com"; 
        let socket, myRole = "", isVip = localStorage.getItem('isVip') === 'true';
        let myName = localStorage.getItem('myName') || "–ò–≥—Ä–æ–∫";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function saveName() {
            const val = document.getElementById('name-input').value;
            if(val) {
                myName = val;
                localStorage.setItem('myName', val);
                showScreen('screen-menu');
            }
        }

        function buyVip() {
            tg.showConfirm("–ö—É–ø–∏—Ç—å VIP —á–µ—Ä–µ–∑ Telegram Stars?", (ok) => {
                if(ok) {
                    isVip = true;
                    localStorage.setItem('isVip', 'true');
                    tg.showAlert("–í—ã –∫—É–ø–∏–ª–∏ VIP! –ö–æ—Ä–æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä–µ.");
                    location.reload();
                }
            });
        }

        function startConnect(mode, limit = 2) {
            if(!localStorage.getItem('myName')) { showScreen('screen-settings'); return; }
            showScreen('screen-lobby');
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                socket.emit('join_room', { limit, name: myName, isVip });
            });

            socket.on('update_lobby', data => {
                document.getElementById('code-display').innerText = data.roomId;
                document.getElementById('count-display').innerText = `${data.playersCount} / ${data.limit}`;
            });

            socket.on('start_game', data => {
                showScreen('screen-game');
                myRole = data.role;
                document.getElementById('role-tag').innerText = "ROLE: " + data.role.toUpperCase();
                renderActions(data.playersList, 'night');
            });

            socket.on('phase_change', data => {
                document.getElementById('phase-tag').innerText = data.phase.toUpperCase();
                document.getElementById('phase-tag').style.color = "#f1c40f"; // –ó–æ–ª–æ—Ç–æ–π –¥–ª—è –¥–Ω—è
                renderActions(data.playersList, 'day');
            });

            socket.on('chat_event', data => {
                const chat = document.getElementById('game-chat');
                const m = document.createElement('div');
                m.className = data.type === 'sys' ? 'msg sys' : 'msg';
                
                const sysText = { night_start: "üåô –ù–æ—á—å –Ω–∞—Å—Ç—É–ø–∏–ª–∞. –ú–∞—Ñ–∏—è —Ö–æ–¥–∏—Ç.", day_start: "‚òÄÔ∏è –£—Ç—Ä–æ! –û–±—Å—É–∂–¥–∞–µ–º –∏ –≥–æ–ª–æ—Å—É–µ–º.", action_done: "üé≠ –ú–∞—Ñ–∏—è —Å–¥–µ–ª–∞–ª–∞ –≤—ã–±–æ—Ä." };
                let text = data.type === 'sys' ? (sysText[data.text] || data.text) : data.text;
                
                m.innerHTML = data.type === 'sys' ? `‚Ä¢ ${text}` : `<b style="color:${data.isVip?'#f1c40f':'#ff3b30'}">${data.user}:</b> ${text}`;
                chat.appendChild(m);
                chat.scrollTop = 9999;
            });
        }

        function renderActions(players, phase) {
            const list = document.getElementById('action-list');
            const pannel = document.getElementById('action-pannel');
            list.innerHTML = "";
            pannel.style.display = 'block';

            if(phase === 'night') {
                if(myRole !== 'mafia') { pannel.style.display = 'none'; return; }
                players.forEach(p => {
                    if(p.id !== socket.id)
                        list.innerHTML += `<button class="btn btn-main" onclick="sendAct('${p.id}')">–£–ë–ò–¢–¨ ${p.name}</button>`;
                });
            } else {
                document.getElementById('action-hint').innerText = "–ì–û–õ–û–°–û–í–ê–ù–ò–ï:";
                players.forEach(p => {
                    if(p.id !== socket.id)
                        list.innerHTML += `<button class="btn btn-glass" onclick="vote('${p.name}')">${p.name}</button>`;
                });
            }
        }

        function sendAct(tid) {
            socket.emit('game_action', { target: tid });
            document.getElementById('action-pannel').style.display = 'none';
        }

        function vote(name) {
            socket.emit('chat', { text: `–Ø –≥–æ–ª–æ—Å—É—é –ø—Ä–æ—Ç–∏–≤ ${name}!` });
            document.getElementById('action-pannel').style.display = 'none';
        }

        function sendMsg() {
            const i = document.getElementById('msg-input');
            if(i.value) socket.emit('chat', { text: i.value });
            i.value = "";
        }
    </script>
</body>
</html>
