<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAFIA: NOIR EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@900&family=Roboto:wght@300;700&display=swap');

        :root {
            --bg: #0d0d0f;
            --card: #16161a;
            --accent: #ff3b30;
            --gold: #d4af37;
            --text: #e0e0e0;
        }

        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Roboto', sans-serif; overflow: hidden;
        }

        .container { height: 100vh; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .screen { display: none; flex-direction: column; height: 100%; transition: 0.5s ease; }
        .active { display: flex; }

        h1 { font-family: 'Playfair Display', serif; font-size: 3rem; margin: 0; color: var(--accent); text-align: center; }

        .btn {
            background: var(--accent); color: white; border: none; padding: 18px;
            border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: 0.3s; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn-outline { background: transparent; border: 1px solid #333; }
        .btn-gold { background: linear-gradient(45deg, #af9500, #d4af37); color: black; }

        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #222; margin-bottom: 15px; }
        input {
            background: #000; border: 1px solid #333; padding: 15px; border-radius: 10px;
            color: white; font-size: 1rem; margin-bottom: 20px; outline: none;
        }

        #chat { flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border-radius: 15px; }
        .msg { margin-bottom: 8px; font-size: 0.9rem; border-left: 2px solid var(--accent); padding-left: 10px; }
        .sys-msg { color: var(--gold); border-left: 2px solid var(--gold); font-style: italic; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .role-badge { background: var(--gold); color: black; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div id="scr-main" class="screen active">
            <h1>MAFIA</h1>
            <p style="text-align:center; opacity:0.5; margin-bottom:40px">NOIR MULTIPLAYER</p>
            
            <div style="margin-top:auto">
                <button class="btn" onclick="joinGame()">–ù–∞–π—Ç–∏ –∏–≥—Ä—É</button>
                <button class="btn btn-outline" onclick="showScreen('scr-settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn btn-gold" onclick="showScreen('scr-shop')">VIP –ú–∞–≥–∞–∑–∏–Ω</button>
            </div>
        </div>

        <div id="scr-settings" class="screen">
            <h2>–ü–†–û–§–ò–õ–¨</h2>
            <div class="card">
                <label style="display:block; margin-bottom:10px">–í–∞—à–µ –∏–º—è –≤ –∏–≥—Ä–µ:</label>
                <input type="text" id="username-in" placeholder="–î–µ—Ç–µ–∫—Ç–∏–≤...">
                <button class="btn" style="width:100%" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <button class="btn btn-outline" style="margin-top:auto" onclick="showScreen('scr-main')">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="scr-shop" class="screen">
            <h2>–ú–ê–ì–ê–ó–ò–ù</h2>
            <div class="card" style="border: 1px solid var(--gold)">
                <h3 style="color:var(--gold)">VIP STATUS</h3>
                <p>–£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ—Ä–æ–Ω–∞ üëë –∏ –∑–æ–ª–æ—Ç–æ–π –Ω–∏–∫ –≤ —á–∞—Ç–µ.</p>
                <button class="btn btn-gold" style="width:100%" onclick="buyVip()">–ö—É–ø–∏—Ç—å (500 Stars)</button>
            </div>
            <button class="btn btn-outline" style="margin-top:auto" onclick="showScreen('scr-main')">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="scr-game" class="screen">
            <div class="status-bar">
                <div id="role-box" class="role-badge">–û–ñ–ò–î–ê–ù–ò–ï...</div>
                <div id="phase-box" style="font-weight:bold; color:var(--accent)">–ù–û–ß–¨</div>
            </div>

            <div id="chat"></div>

            <div id="actions" class="card" style="display:none">
                <p id="action-title" style="margin:0 0 10px 0; font-size:0.8rem">–í–ê–®–ï –î–ï–ô–°–¢–í–ò–ï:</p>
                <div id="action-btns"></div>
            </div>

            <div style="display:flex; gap:10px">
                <input type="text" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0; flex-grow:1">
                <button class="btn" style="margin:0; width:60px" onclick="sendChat()">üì°</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io("–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ù–ê_RENDER");
        let myData = {
            name: localStorage.getItem('mafia_name') || tg.initDataUnsafe?.user?.first_name || "–î–µ—Ç–µ–∫—Ç–∏–≤",
            isVip: localStorage.getItem('mafia_vip') === 'true'
        };

        document.getElementById('username-in').value = myData.name;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function saveProfile() {
            myData.name = document.getElementById('username-in').value;
            localStorage.setItem('mafia_name', myData.name);
            tg.showAlert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
            showScreen('scr-main');
        }

        function buyVip() {
            tg.showConfirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É VIP?", (ok) => {
                if(ok) {
                    localStorage.setItem('mafia_vip', 'true');
                    myData.isVip = true;
                    tg.showAlert("–ö–æ—Ä–æ–Ω–∞ –≤–∞—à–∞! üëë");
                    location.reload();
                }
            });
        }

        function joinGame() {
            showScreen('scr-game');
            addMsg("–ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç...", true);
            socket.emit('join_match', myData);
        }

        socket.on('lobby_update', (d) => {
            addMsg(`–ò–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏: ${d.count}/${d.needed}`, true);
        });

        socket.on('game_start', (d) => {
            document.getElementById('role-box').innerText = d.role.toUpperCase();
            addMsg("–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –†–æ–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.", true);
            
            if(d.role === 'mafia') {
                showActions(d.players, 'kill');
            }
        });

        socket.on('new_phase', (d) => {
            document.getElementById('phase-box').innerText = d.phase.toUpperCase();
            document.getElementById('phase-box').style.color = d.phase === 'day' ? '#d4af37' : '#ff3b30';
            addMsg(d.msg, true);
            
            if(d.phase === 'day') {
                socket.emit('get_alive_players'); // –ú–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å—Ä–∞–∑—É
                showActions([], 'vote'); 
            }
        });

        function showActions(players, type) {
            const container = document.getElementById('actions');
            const btns = document.getElementById('action-btns');
            container.style.display = 'block';
            btns.innerHTML = "";

            if(type === 'kill') {
                players.forEach(p => {
                    if(p.id !== socket.id) {
                        btns.innerHTML += `<button class="btn btn-outline" style="width:100%" onclick="doAction('execute_action', '${p.id}')">–£–ë–ò–¢–¨ ${p.name}</button>`;
                    }
                });
            } else {
                // –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä - –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Å–µ–±—è)
                addMsg("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –∑–∞—Ç–µ–º –≥–æ–ª–æ—Å—É–π—Ç–µ!", true);
                // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
            }
        }

        function doAction(event, tid) {
            socket.emit(event, tid);
            document.getElementById('actions').style.display = 'none';
        }

        function addMsg(text, isSys = false) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = isSys ? 'msg sys-msg' : 'msg';
            div.innerText = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function sendChat() {
            const inp = document.getElementById('msg-in');
            if(inp.value) {
                socket.emit('send_chat', inp.value);
                inp.value = "";
            }
        }
    </script>
</body>
</html>
