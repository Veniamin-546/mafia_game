<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR ULTIMATE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #050507; --card: #121216; --accent: #ff3b30;
            --gold: #f1c40f; --text: #ffffff; --gray: #636366; --glass: rgba(255, 255, 255, 0.05);
        }
        body {
            margin: 0; background-color: var(--bg); color: var(--text);
            font-family: -apple-system, system-ui, sans-serif; overflow: hidden;
            background-image: radial-gradient(circle at 50% -20%, #1c1c24, #050507);
        }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 24px; box-sizing: border-box; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é */
        .btn { padding: 18px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; margin-bottom: 12px; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #ff453a, #c62828); color: white; box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3); }
        .btn-secondary { background: var(--glass); color: white; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .btn-gold { background: var(--gold); color: black; }

        /* –í—ã–±–æ—Ä –∏–≥—Ä–æ–∫–æ–≤ */
        .limit-selector { display: flex; justify-content: space-around; margin: 30px 0; gap: 10px; }
        .limit-btn { flex: 1; padding: 15px; background: var(--card); border: 1px solid #333; border-radius: 12px; color: white; cursor: pointer; }
        .limit-btn.selected { border-color: var(--accent); background: rgba(255, 59, 48, 0.1); color: var(--accent); }

        /* –†–∞–¥–∞—Ä */
        .radar-box { width: 120px; height: 120px; border: 2px solid var(--accent); border-radius: 50%; margin: 30px auto; position: relative; display: flex; justify-content: center; align-items: center; }
        .radar-box::after { content: ''; position: absolute; width: 100%; height: 100%; border: 2px solid var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }

        .room-code { font-size: 42px; font-weight: 900; color: var(--gold); letter-spacing: 10px; text-align: center; margin: 10px 0; cursor: pointer; }

        /* –ò–≥—Ä–∞ –∏ —á–∞—Ç */
        #chat-area { flex-grow: 1; background: var(--card); border-radius: 20px; padding: 15px; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--glass); }
        .msg { margin-bottom: 8px; font-size: 14px; line-height: 1.4; }
        .msg b { color: var(--accent); }
        .input-box { display: flex; gap: 8px; }
        input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #222; color: white; outline: none; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div style="text-align: center; margin-top: 40px;">
            <h1 style="font-size: 48px; letter-spacing: 10px; color: var(--accent); margin: 0;">MAFIA</h1>
            <p style="color: var(--gray); letter-spacing: 3px; font-size: 10px;">PRO MULTIPLAYER</p>
        </div>
        <div style="margin-top: auto;">
            <button class="btn btn-primary" onclick="joinMode('online')">–ò–≥—Ä–∞—Ç—å –û–Ω–ª–∞–π–Ω</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-local-setup')">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-join-input')">–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</button>
            <button class="btn btn-gold" onclick="showScreen('screen-shop')">–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</button>
        </div>
    </div>

    <div id="screen-local-setup" class="screen">
        <h2 style="text-align: center;">–ù–ê–°–¢–†–û–ô–ö–ê</h2>
        <p style="color: var(--gray); text-align: center;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</p>
        <div class="limit-selector">
            <button class="limit-btn" onclick="setPlayerLimit(this, 5)">5</button>
            <button class="limit-btn" onclick="setPlayerLimit(this, 7)">7</button>
            <button class="limit-btn selected" onclick="setPlayerLimit(this, 10)">10</button>
        </div>
        <button class="btn btn-primary" onclick="joinMode('local')">–°–û–ó–î–ê–¢–¨</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-lobby" class="screen" style="text-align: center;">
        <div id="code-section" style="display: none;">
            <p style="color: var(--gray); margin-bottom: 0;">–ö–æ–¥ –¥–ª—è –¥—Ä—É–∑–µ–π (–Ω–∞–∂–º–∏):</p>
            <div class="room-code" id="room-code-val" onclick="copyCode()">----</div>
        </div>
        <div class="radar-box">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h2 id="search-status">–ü–û–ò–°–ö –ò–ì–†–û–ö–û–í...</h2>
        <p id="player-count">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: 1 / --</p>
        <button class="btn btn-secondary" style="margin-top: auto;" onclick="exitQueue()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="screen-join-input" class="screen">
        <h2 style="text-align: center;">–í–•–û–î –í –õ–û–ë–ë–ò</h2>
        <input type="number" id="code-input" placeholder="0000" style="font-size: 32px; text-align: center; margin: 40px 0;">
        <button class="btn btn-primary" onclick="joinByCode()">–í–û–ô–¢–ò</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="my-role" style="color: var(--gold); font-weight: bold; font-size: 14px;">–†–û–õ–¨: ???</div>
            <div id="game-phase" style="font-size: 12px; color: var(--accent);">–î–ï–ù–¨</div>
        </div>
        <div id="chat-area"></div>
        <div class="input-box">
            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn-primary" style="width: 60px; margin: 0; border-radius: 12px;" onclick="send()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –°–Æ–î–ê –ù–£–ñ–ù–û –í–°–¢–ê–í–ò–¢–¨ –ê–î–†–ï–° –¢–í–û–ï–ì–û –°–ï–†–í–ï–†–ê
        const SERVER_URL = "https://your-backend-api.com"; 
        let socket;
        let selectedLimit = 10;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            tg.HapticFeedback.impactOccurred('medium');
        }

        function setPlayerLimit(btn, num) {
            document.querySelectorAll('.limit-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedLimit = num;
        }

        function joinMode(mode) {
            showScreen('screen-lobby');
            document.getElementById('code-section').style.display = (mode === 'local') ? 'block' : 'none';
            document.getElementById('search-status').innerText = (mode === 'local') ? "–û–ñ–ò–î–ê–ù–ò–ï –ì–†–£–ü–ü–´" : "–û–ù–õ–ê–ô–ù –ü–û–ò–°–ö";
            
            initSocket(mode, selectedLimit);
        }

        function initSocket(mode, limit, code = null) {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç, –≤–∫–ª—é—á–∞–µ–º –¥–µ–º–æ-—Ä–µ–∂–∏–º, —á—Ç–æ–±—ã –¢–´ –≤–∏–¥–µ–ª –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
            if (SERVER_URL.includes("your-backend")) {
                document.getElementById('player-count').innerText = `–î–µ–º–æ-—Ä–µ–∂–∏–º: –∂–¥–µ–º —Å–µ—Ä–≤–µ—Ä...`;
                return;
            }

            socket = io(SERVER_URL);
            
            socket.on('connect', () => {
                socket.emit('request_join', {
                    user: tg.initDataUnsafe.user,
                    mode: mode,
                    limit: limit,
                    code: code
                });
            });

            socket.on('room_info', (data) => {
                document.getElementById('room-code-val').innerText = data.code;
                document.getElementById('player-count').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${data.current} / ${data.total}`;
            });

            socket.on('start_game', (data) => {
                showScreen('screen-game');
                document.getElementById('my-role').innerText = "–í–ê–®–ê –†–û–õ–¨: " + data.role;
                tg.HapticFeedback.notificationOccurred('success');
            });

            socket.on('new_msg', (data) => {
                const chat = document.getElementById('chat-area');
                chat.innerHTML += `<div class="msg"><b>${data.user}:</b> ${data.text}</div>`;
                chat.scrollTop = chat.scrollHeight;
            });
        }

        function joinByCode() {
            const val = document.getElementById('code-input').value;
            if (val.length < 4) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥!");
            showScreen('screen-lobby');
            initSocket('join', 0, val);
        }

        function send() {
            const inp = document.getElementById('chat-input');
            if (!inp.value || !socket) return;
            socket.emit('send_msg', { text: inp.value });
            inp.value = "";
        }

        function copyCode() {
            const code = document.getElementById('room-code-val').innerText;
            navigator.clipboard.writeText(code);
            tg.showAlert("–ö–æ–¥ " + code + " —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        }

        function exitQueue() {
            if (socket) socket.disconnect();
            showScreen('screen-menu');
        }
    </script>
</body>
</html>
