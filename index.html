<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #050507; --accent: #ff3b30; --gold: #f1c40f; --text: #fff; --glass: rgba(255,255,255,0.05); }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .btn-main { background: var(--accent); color: #fff; }
        .btn-glass { background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-gold { background: var(--gold); color: #000; }
        #game-chat { flex-grow: 1; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--glass); }
        .msg { font-size: 14px; margin-bottom: 5px; }
        .msg.sys { color: var(--gold); font-style: italic; }
        input { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1 style="text-align:center; letter-spacing:5px">MAFIA</h1>
        <div style="margin-top:auto">
            <button class="btn btn-main" onclick="startConnect('online')" id="btn-quick">–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</button>
            <button class="btn btn-glass" onclick="showScreen('screen-setup')" id="btn-create">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button class="btn btn-gold" onclick="showScreen('screen-shop')" id="btn-shop">–ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
            <button class="btn btn-glass" onclick="showScreen('screen-settings')" id="btn-settings">–ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <h2>SHOP</h2>
        <div style="background:var(--glass); padding:20px; border-radius:15px; border:1px solid var(--gold); text-align:center">
            <b style="color:var(--gold); font-size:20px">VIP –°–¢–ê–¢–£–° üëë</b>
            <p id="vip-desc">–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫ + –ö–æ—Ä–æ–Ω–∞</p>
            <button class="btn btn-gold" onclick="pay()">500 ‚≠ê / STARS</button>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">BACK</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; font-size:12px">
            <b id="role-tag" style="color:var(--gold)">ROLE: ???</b>
            <b id="phase-tag" style="color:var(--accent)">NIGHT</b>
        </div>
        <div id="action-pannel" style="background:var(--glass); padding:10px; border-radius:10px; margin:10px 0">
            <small id="action-hint">–í–∞—à —Ö–æ–¥:</small>
            <div id="action-list"></div>
        </div>
        <div id="game-chat"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="msg-input" placeholder="..." style="margin:0">
            <button class="btn-main" style="width:60px; margin:0" onclick="sendMsg()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SERVER_URL = "https://mafia-game-skw7.onrender.com"; 
        let socket, myRole = "", isVip = localStorage.getItem('vip') === 'true';
        let lang = localStorage.getItem('lang') || 'ru';

        const dict = {
            ru: { night_start: "üåô –ù–æ—á—å: –ì–æ—Ä–æ–¥ –∑–∞—Å—ã–ø–∞–µ—Ç...", day_start: "‚òÄÔ∏è –£—Ç—Ä–æ: –í—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å!", action_stealth: "üåë –ö—Ç–æ-—Ç–æ —Å–∫—Ä—ã–ª—Å—è...", action_done: "üé≠ –•–æ–¥ —Å–æ–≤–µ—Ä—à–µ–Ω.", mafia: "–ú–ê–§–ò–Ø", citizen: "–ú–ò–†–ù–´–ô" },
            en: { night_start: "üåô Night: City falls asleep...", day_start: "‚òÄÔ∏è Morning: Time to vote!", action_stealth: "üåë Someone hid...", action_done: "üé≠ Action done.", mafia: "MAFIA", citizen: "CITIZEN" }
        };

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        // –†–ï–ê–õ–¨–ù–ê–Ø –û–ü–õ–ê–¢–ê
        function pay() {
            // –í–ê–ñ–ù–û: –¢—É—Ç –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Å—ã–ª–∫–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–≤–æ–∏–º –±–æ—Ç–æ–º —á–µ—Ä–µ–∑ BotFather
            const invoiceUrl = ""; // –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å

            if(!invoiceUrl) {
                tg.showConfirm(lang === 'ru' ? "–£ –≤–∞—Å –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É. –•–æ—Ç–∏—Ç–µ –≤–∫–ª—é—á–∏—Ç—å –¢–ï–°–¢–û–í–´–ô VIP?" : "No invoice link. Enable TEST VIP?", (ok) => {
                    if(ok) { isVip = true; localStorage.setItem('vip', 'true'); location.reload(); }
                });
                return;
            }

            tg.openInvoice(invoiceUrl, (status) => {
                if(status === 'paid') {
                    isVip = true; localStorage.setItem('vip', 'true');
                    tg.showAlert("SUCCESS! üëë");
                    location.reload();
                }
            });
        }

        function startConnect(mode, limit = 2) {
            showScreen('screen-lobby');
            socket = io(SERVER_URL);
            socket.on('connect', () => {
                socket.emit('join_room', { limit, name: localStorage.getItem('name'), isVip });
            });

            socket.on('start_game', data => {
                showScreen('screen-game');
                myRole = data.role;
                document.getElementById('role-tag').innerText = "ROLE: " + data.role.toUpperCase();
                renderActions(data.playersList, 'night');
            });

            socket.on('phase_change', data => {
                document.getElementById('phase-tag').innerText = data.phase.toUpperCase();
                document.getElementById('phase-tag').style.color = "#f1c40f";
                document.getElementById('game-chat').innerHTML += `<div class="msg sys">‚Ä¢ ${dict[lang][data.text]}</div>`;
                renderActions(data.playersList, 'day');
            });

            socket.on('chat_event', data => {
                let text = data.text;
                if(data.type === 'sys') text = dict[lang][text] || text;
                const m = document.createElement('div');
                m.className = data.type === 'sys' ? 'msg sys' : 'msg';
                m.innerHTML = data.type === 'sys' ? `‚Ä¢ ${text}` : `<b style="color:${data.isVip?'#f1c40f':'#ff3b30'}">${data.user}:</b> ${text}`;
                document.getElementById('game-chat').appendChild(m);
                document.getElementById('game-chat').scrollTop = 9999;
            });
        }

        function renderActions(players, phase) {
            const list = document.getElementById('action-list');
            const hint = document.getElementById('action-hint');
            list.innerHTML = "";
            document.getElementById('action-pannel').style.display = 'block';

            if (phase === 'night') {
                if (myRole === 'citizen') { document.getElementById('action-pannel').style.display = 'none'; return; }
                players.forEach(p => {
                    if(p.name !== localStorage.getItem('name'))
                        list.innerHTML += `<button class="btn btn-glass" onclick="sendAct('act','${p.id}','${p.name}')">${p.name}</button>`;
                });
                if(myRole === 'mafia') list.innerHTML += `<button class="btn btn-main" onclick="sendAct('hide','','')">HIDE</button>`;
            } else {
                // –ì–û–õ–û–°–û–í–ê–ù–ò–ï –î–ù–ï–ú
                hint.innerText = lang === 'ru' ? "–ì–û–õ–û–°–û–í–ê–ù–ò–ï:" : "VOTING:";
                players.forEach(p => {
                    if(p.name !== localStorage.getItem('name'))
                        list.innerHTML += `<button class="btn btn-main" onclick="vote('${p.name}')">${p.name}</button>`;
                });
            }
        }

        function sendAct(a, id, n) {
            socket.emit('game_action', { action: a, target: id, targetName: n });
            document.getElementById('action-pannel').style.display = 'none';
        }

        function vote(name) {
            socket.emit('chat', { text: `üì¢ VOTE AGAINST: ${name}` });
            document.getElementById('action-pannel').style.display = 'none';
        }

        function sendMsg() {
            const i = document.getElementById('msg-input');
            if(i.value) socket.emit('chat', { text: i.value });
            i.value = "";
        }
    </script>
</body>
</html>
