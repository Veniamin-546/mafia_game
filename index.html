<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–≤–æ–π –¥–∏–∑–∞–π–Ω */
        :root { --red: #e63946; --gold: #ffb703; --bg: #0a0a0b; --card: #16161a; --border: rgba(255, 255, 255, 0.08); }
        body { margin: 0; background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 18px; border-radius: 18px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-bottom: 10px; width: 100%; }
        .btn-primary { background: var(--red); color: #fff; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-glass { background: var(--card); color: #fff; border: 1px solid var(--border); }
        #chat { flex-grow: 1; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .msg { margin-bottom: 10px; font-size: 14px; }
        .msg b { color: var(--red); }
        .action-box { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid var(--red); margin-bottom: 10px; display: none; }
        input { background: #000; border: 1px solid var(--border); padding: 15px; border-radius: 12px; color: #fff; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="scr-menu" class="screen active">
        <h1 style="text-align:center; color:var(--red); font-size:40px;">MAFIA</h1>
        <div style="margin-top:auto">
            <button class="btn btn-primary" onclick="startFind()">–ù–ê–ô–¢–ò –ò–ì–†–£</button>
            <button class="btn btn-gold" onclick="showScreen('scr-shop')">STARS SHOP ‚≠ê</button>
        </div>
    </div>

    <div id="scr-shop" class="screen">
        <h1>SHOP</h1>
        <div class="btn btn-glass" onclick="buyStars('vip', 500)">–ö–£–ü–ò–¢–¨ VIP (500 ‚≠ê)</div>
        <div class="btn btn-glass" onclick="buyStars('luck', 250)">–®–ê–ù–° –ú–ê–§–ò–ò (250 ‚≠ê)</div>
        <button class="btn btn-primary" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="scr-lobby" class="screen">
        <h1 style="text-align:center; margin-top:50px">–ü–û–ò–°–ö...</h1>
        <div style="text-align:center; font-size:40px" id="l-count">1 / 3</div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="scr-game" class="screen">
        <div style="display:flex; justify-content:space-between; font-weight:bold">
            <span id="g-role" style="color:var(--gold)">...</span>
            <span id="g-phase" style="color:var(--red)">–ù–û–ß–¨</span>
        </div>
        
        <div id="chat"></div>

        <div id="action-ui" class="action-box">
            <p id="action-text" style="font-size:12px; margin:0 0 10px"></p>
            <div id="targets-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px"></div>
        </div>

        <div style="display:flex; gap:10px">
            <input type="text" id="m-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn btn-primary" style="width:60px; margin:0" onclick="sendChat()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL
        const socket = io("https://—Ç–≤–æ–π-—Å–µ—Ä–≤–µ—Ä.onrender.com");
        
        let myRole = "";
        let players = [];
        let myId = "";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- –û–ü–õ–ê–¢–ê –ß–ï–†–ï–ó –ë–û–¢–ê ---
        function buyStars(type, amount) {
            socket.emit('create_stars_invoice', { type, amount });
        }

        socket.on('invoice_link', (url) => {
            tg.openInvoice(url, (status) => {
                if (status === 'paid') tg.showAlert("–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.");
            });
        });

        // --- –ü–û–ò–°–ö ---
        function startFind() {
            showScreen('scr-lobby');
            socket.emit('join_queue', { name: tg.initDataUnsafe?.user?.first_name || "Gamer" });
        }

        socket.on('queue_size', c => document.getElementById('l-count').innerText = `${c} / 3`);

        socket.on('start_game', d => {
            myRole = d.role;
            players = d.players;
            myId = socket.id;
            showScreen('scr-game');
            document.getElementById('g-role').innerText = "–†–û–õ–¨: " + d.role.toUpperCase();
            setPhase('night');
        });

        // --- –õ–û–ì–ò–ö–ê –•–û–î–û–í ---
        socket.on('change_phase', d => {
            if (d.killed === myId) {
                tg.showAlert("–í–∞—Å —É–±–∏–ª–∏!");
                location.reload();
            }
            if (d.commResult && myRole === 'comm') {
                addMsg(`–†–ï–ó–£–õ–¨–¢–ê–¢: ${d.commResult.isMafia ? '–ú–ê–§–ò–Ø' : '–ú–ò–†–ù–´–ô'}`, true);
            }
            setPhase(d.phase);
        });

        function setPhase(p) {
            document.getElementById('g-phase').innerText = p === 'night' ? "–ù–û–ß–¨" : "–î–ï–ù–¨";
            const ui = document.getElementById('action-ui');
            const grid = document.getElementById('targets-grid');
            grid.innerHTML = "";

            if (p === 'night') {
                ui.style.display = 'block';
                if (myRole === 'mafia') document.getElementById('action-text').innerText = "–ö–û–ì–û –£–ë–ò–¢–¨?";
                if (myRole === 'doctor') document.getElementById('action-text').innerText = "–ö–û–ì–û –õ–ï–ß–ò–¢–¨?";
                if (myRole === 'comm') document.getElementById('action-text').innerText = "–ö–û–ì–û –ü–†–û–í–ï–†–ò–¢–¨?";

                players.forEach(pl => {
                    grid.innerHTML += `<button class="btn btn-glass" style="font-size:10px" onclick="doAction('${pl.id}')">${pl.name}</button>`;
                });
                // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞ —Ö–æ–¥–∞ –¥–ª—è –º–∞—Ñ–∏–∏
                if (myRole === 'mafia') grid.innerHTML += `<button class="btn btn-glass" onclick="doAction(null)">–ü–†–û–ü–£–°–¢–ò–¢–¨</button>`;
            } else {
                ui.style.display = 'none';
            }
        }

        function doAction(tid) {
            socket.emit('night_action', { targetId: tid, type: myRole });
            document.getElementById('action-ui').style.display = 'none';
        }

        // --- –ß–ê–¢ ---
        function sendChat() {
            const i = document.getElementById('m-in');
            if (i.value) { socket.emit('send_msg', i.value); i.value = ""; }
        }

        socket.on('new_msg', d => {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="msg"><b>${d.user}:</b> ${d.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        function addMsg(text, isSys) {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="msg" style="${isSys?'color:var(--gold)':''}">${text}</div>`;
        }
    </script>
</body>
</html>
