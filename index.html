<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mafia Online Real-Time</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0c;
            --card: #16161a;
            --accent: #ff3b30;
            --gold: #f1c40f;
            --text: #ffffff;
            --gray: #8e8e93;
            --night-color: #5856d6;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .screen {
            display: none; height: 100vh; flex-direction: column;
            padding: 20px; box-sizing: border-box;
        }
        .active { display: flex; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- MENU --- */
        #screen-menu { justify-content: center; align-items: center; text-align: center; }
        .logo h1 { font-size: 50px; margin: 0; letter-spacing: 8px; color: var(--accent); }
        .menu-btns { width: 100%; max-width: 300px; display: grid; gap: 12px; margin-top: 40px; }

        /* --- LOADING (REAL SEARCH) --- */
        #screen-loading { justify-content: center; align-items: center; }
        .radar {
            width: 120px; height: 120px; border: 3px solid var(--accent);
            border-radius: 50%; position: relative; margin-bottom: 30px;
            display: flex; justify-content: center; align-items: center;
        }
        .radar::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            border: 2px solid var(--accent); border-radius: 50%; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.8); opacity: 0; } }

        /* --- GAME --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .phase-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .day { background: var(--accent); color: white; }
        .night { background: var(--night-color); color: white; }

        #chat-area {
            flex-grow: 1; background: var(--card); border-radius: 15px;
            padding: 15px; overflow-y: auto; border: 1px solid #2c2c2e; margin-bottom: 15px;
        }
        .message { margin-bottom: 10px; font-size: 14px; }
        .message b { color: var(--accent); }
        .sys-msg { color: var(--gold); text-align: center; font-size: 12px; margin: 10px 0; }

        .input-bar { display: flex; gap: 10px; }
        input {
            flex-grow: 1; background: #24242b; border: 1px solid #3a3a42;
            border-radius: 12px; padding: 12px; color: white; outline: none;
        }

        button {
            padding: 15px; border-radius: 12px; border: none; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .btn-red { background: var(--accent); color: white; }
        .btn-gray { background: var(--card); color: white; border: 1px solid #333; }
        .btn-gold { background: var(--gold); color: black; }

        /* --- SHOP --- */
        .shop-item {
            background: var(--card); padding: 15px; border-radius: 15px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="logo">
            <h1>MAFIA</h1>
            <p style="color: var(--gray)">ONLINE MULTIPLAYER</p>
        </div>
        <div class="menu-btns">
            <button class="btn-red" onclick="connectToServer()">–ò–ì–†–ê–¢–¨ –û–ù–õ–ê–ô–ù</button>
            <button class="btn-gray" onclick="tg.showAlert('–†–µ–∂–∏–º —Å –¥—Ä—É–∑—å—è–º–∏ —Å–∫–æ—Ä–æ!')">–° –î–†–£–ó–¨–Ø–ú–ò</button>
            <button class="btn-gold" onclick="showScreen('screen-shop')">–ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
        </div>
    </div>

    <div id="screen-loading" class="screen">
        <div class="radar">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h2 id="loading-status">–ü–û–ò–°–ö –ò–ì–†–û–ö–û–í...</h2>
        <p id="player-count">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: 1 / 10</p>
        <button class="btn-gray" style="margin-top: 30px;" onclick="disconnect()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="header">
            <div id="phase-label" class="phase-badge day">–î–ï–ù–¨: –û–ë–°–£–ñ–î–ï–ù–ò–ï</div>
            <div id="my-role" style="font-size: 12px; color: var(--gold)">–†–æ–ª—å: ???</div>
        </div>
        <div id="chat-area"></div>
        <div class="input-bar">
            <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn-red" onclick="sendMessage()">üì°</button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="header">
            <h2>–ú–ê–ì–ê–ó–ò–ù</h2>
            <button class="btn-gray" onclick="showScreen('screen-menu')">‚úï</button>
        </div>
        <div class="shop-item">
            <span>–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫</span>
            <button class="btn-gold" onclick="buyItem('gold', 100)">100 ‚≠ê</button>
        </div>
        <div class="shop-item">
            <span>–†–æ–ª—å –ú–∞—Ñ–∏–∏ (—à–∞–Ω—Å+)</span>
            <button class="btn-gold" onclick="buyItem('chance', 250)">250 ‚≠ê</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –°—é–¥–∞ –≤—Å—Ç–∞–≤—å URL —Å–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
        const SOCKET_URL = "https://your-backend-api.com"; 
        let socket;
        let myName = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function connectToServer() {
            showScreen('screen-loading');
            
            // –ï—Å–ª–∏ —Å–æ–∫–µ—Ç —É–∂–µ –µ—Å—Ç—å, –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            if (socket) socket.disconnect();

            socket = io(SOCKET_URL, {
                query: { name: myName, tgId: tg.initDataUnsafe?.user?.id }
            });

            // –ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –∑–∞—Ö–æ–¥–∏—Ç/–≤—ã—Ö–æ–¥–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å
            socket.on('queue_update', (data) => {
                document.getElementById('player-count').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${data.count} / 10`;
            });

            // –ö–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä —Å–æ–±—Ä–∞–ª 10 —á–µ–ª–æ–≤–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–ª –º–∞—Ç—á
            socket.on('game_start', (data) => {
                showScreen('screen-game');
                document.getElementById('my-role').innerText = "–†–æ–ª—å: " + data.role;
                addSystemMsg(`–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—ã ‚Äî ${data.role}`);
                tg.HapticFeedback.notificationOccurred('success');
            });

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
            socket.on('chat_message', (data) => {
                appendMessage(data.user, data.text);
            });

            // –°–º–µ–Ω–∞ —Ñ–∞–∑—ã (–î–µ–Ω—å/–ù–æ—á—å)
            socket.on('change_phase', (data) => {
                const label = document.getElementById('phase-label');
                label.innerText = data.phase === 'night' ? "–ù–û–ß–¨: –ú–ê–§–ò–Ø –•–û–î–ò–¢" : "–î–ï–ù–¨: –û–ë–°–£–ñ–î–ï–ù–ò–ï";
                label.className = `phase-badge ${data.phase}`;
                addSystemMsg(data.phase === 'night' ? "–ì–æ—Ä–æ–¥ –∑–∞—Å—ã–ø–∞–µ—Ç..." : "–ì–æ—Ä–æ–¥ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è!");
            });
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if (!input.value) return;

            socket.emit('send_chat', { text: input.value });
            appendMessage("–í—ã", input.value); // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            input.value = "";
            tg.HapticFeedback.impactOccurred('light');
        }

        function appendMessage(user, text) {
            const chat = document.getElementById('chat-area');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = `<b>${user}:</b> ${text}`;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function addSystemMsg(text) {
            const chat = document.getElementById('chat-area');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'sys-msg';
            msgDiv.innerText = text;
            chat.appendChild(msgDiv);
        }

        function disconnect() {
            if (socket) socket.disconnect();
            showScreen('screen-menu');
        }

        function buyItem(id, price) {
            tg.showConfirm(`–ö—É–ø–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∑–∞ ${price} Stars?`, (ok) => {
                if (ok) {
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Invoice
                    tg.showAlert("–°—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–æ–º!");
                }
            });
        }
    </script>
</body>
</html>
