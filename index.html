<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA REALTIME</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #050507; --accent: #ff3b30; --gold: #f1c40f; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 18px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-main { background: var(--accent); color: white; }
        .btn-sec { background: #222; color: white; }
        .room-code { font-size: 40px; color: var(--gold); text-align: center; letter-spacing: 5px; margin: 20px 0; }
        #chat { flex-grow: 1; background: #111; border-radius: 10px; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1 style="text-align:center; color:var(--accent);">MAFIA ONLINE</h1>
        <button class="btn btn-main" onclick="connect('online')">БЫСТРЫЙ ПОИСК</button>
        <button class="btn btn-sec" onclick="showScreen('screen-setup')">СОЗДАТЬ ГРУППУ</button>
        <button class="btn btn-sec" onclick="showScreen('screen-join')">ВХОД ПО КОДУ</button>
        <button class="btn btn-sec" style="color:var(--gold)" onclick="showScreen('screen-shop')">МАГАЗИН ⭐</button>
    </div>

    <div id="screen-setup" class="screen">
        <h2>Игроков в группе:</h2>
        <button class="btn btn-sec" onclick="connect('local', 5)">5 ИГРОКОВ</button>
        <button class="btn btn-sec" onclick="connect('local', 10)">10 ИГРОКОВ</button>
    </div>

    <div id="screen-join" class="screen">
        <h2>Введите код:</h2>
        <input type="number" id="join-input" style="padding:20px; font-size:24px; text-align:center;">
        <button class="btn btn-main" onclick="connect('join')">ВОЙТИ</button>
    </div>

    <div id="screen-lobby" class="screen">
        <div id="code-area" style="display:none;">
            <p>КОД КОМНАТЫ:</p>
            <div class="room-code" id="lobby-code">----</div>
        </div>
        <h2 id="status">ОЖИДАНИЕ СЕРВЕРА...</h2>
        <h1 id="count">1 / --</h1>
        <button class="btn btn-sec" onclick="location.reload()">ОТМЕНА</button>
    </div>

    <div id="screen-game" class="screen">
        <h2 id="role" style="color:var(--gold)">ВАША РОЛЬ: ???</h2>
        <div id="chat"></div>
        <input type="text" id="minp" placeholder="Сообщение...">
    </div>

    <div id="screen-shop" class="screen">
        <h2>МАГАЗИН</h2>
        <button class="btn btn-main" onclick="buy('VIP')">КУПИТЬ VIP (500 ⭐)</button>
        <button class="btn btn-main" onclick="buy('SHANCE')">ШАНС МАФИИ (150 ⭐)</button>
        <button class="btn btn-sec" onclick="showScreen('screen-menu')">НАЗАД</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // !!! ТУТ ДОЛЖЕН БЫТЬ ТВОЙ РЕАЛЬНЫЙ АДРЕС СЕРВЕРА !!!
        const SERVER_URL = "https://mafia-test-server.onrender.com"; 
        let socket;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function connect(mode, limit = 10) {
            showScreen('screen-lobby');
            const codeInput = document.getElementById('join-input').value;

            socket = io(SERVER_URL);

            socket.on('connect', () => {
                document.getElementById('status').innerText = "В ОЧЕРЕДИ...";
                socket.emit('client_join', {
                    user: tg.initDataUnsafe.user,
                    mode: mode,
                    limit: limit,
                    code: codeInput
                });
            });

            // СЛУШАЕМ СЕРВЕР: Реальные данные о людях
            socket.on('room_update', (data) => {
                if(data.code) {
                    document.getElementById('code-area').style.display = 'block';
                    document.getElementById('lobby-code').innerText = data.code;
                }
                document.getElementById('count').innerText = `${data.current} / ${data.total}`;
            });

            // СЛУШАЕМ СЕРВЕР: Начало игры
            socket.on('start', (data) => {
                showScreen('screen-game');
                document.getElementById('role').innerText = "ВАША РОЛЬ: " + data.role;
                tg.HapticFeedback.notificationOccurred('success');
            });

            socket.on('connect_error', () => {
                document.getElementById('status').innerText = "СЕРВЕР ОФФЛАЙН";
            });
        }

        function buy(item) {
            tg.showConfirm(`Купить ${item}?`, (ok) => {
                if(ok) tg.showAlert("Запрос отправлен!");
            });
        }
    </script>
</body>
</html>
