<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #050505; --card: #121212; --red: #ff3b30; --gold: #ffcc00; --text: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { text-align: center; font-size: 40px; letter-spacing: 5px; color: var(--red); text-shadow: 0 0 15px rgba(255, 59, 48, 0.5); margin: 20px 0; }
        
        .btn { padding: 18px; border-radius: 15px; border: none; font-weight: bold; width: 100%; cursor: pointer; transition: 0.3s; font-size: 14px; text-transform: uppercase; margin-bottom: 12px; }
        .btn-red { background: var(--red); color: white; box-shadow: 0 5px 15px rgba(255, 59, 48, 0.3); }
        .btn-outline { background: transparent; border: 1px solid #333; color: white; }
        .btn-gold { background: linear-gradient(45deg, #ffcc00, #ff9500); color: black; }

        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #222; margin-bottom: 15px; }
        input { background: #1a1a1a; border: 1px solid #333; padding: 15px; border-radius: 12px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 15px; outline: none; }

        #chat { flex-grow: 1; background: rgba(255,255,255,0.03); border-radius: 20px; padding: 15px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #1a1a1a; }
        .msg { margin-bottom: 10px; font-size: 14px; line-height: 1.4; }
        .msg b { color: var(--red); }
        .msg.vip b { color: var(--gold); }
        .sys { color: var(--gold); text-align: center; font-style: italic; font-size: 12px; margin: 10px 0; opacity: 0.8; }

        .badge { background: var(--card); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--red); font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="scr-menu" class="screen active">
        <h1>MAFIA</h1>
        <div class="card">
            <input type="text" id="name-in" placeholder="–í–∞—à–µ –∏–º—è...">
            <button class="btn btn-red" onclick="findMatch()">–ù–ê–ô–¢–ò –ò–ì–†–£</button>
        </div>
        <div style="margin-top:auto">
            <button class="btn btn-gold" onclick="showScreen('scr-shop')">VIP –ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
        </div>
    </div>

    <div id="scr-shop" class="screen">
        <h1>SHOP</h1>
        <div class="card" style="border-color: var(--gold); text-align: center;">
            <h2 style="color:var(--gold); margin:0">VIP STATUS üëë</h2>
            <p style="opacity:0.6; font-size:13px">–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫, –∫–æ—Ä–æ–Ω–∞ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –ø–æ–∏—Å–∫–µ</p>
            <button class="btn btn-gold" onclick="buyVip()">500 ‚≠ê / STARS</button>
        </div>
        <button class="btn btn-outline" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="scr-game" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <div id="my-role" class="badge">–†–û–õ–¨: ???</div>
            <div id="game-phase" style="color:var(--red); font-weight:bold">–ù–û–ß–¨</div>
        </div>

        <div id="chat"></div>

        <div id="action-box" class="card" style="display:none; border-color:var(--red)">
            <p id="action-text" style="margin:0 0 10px 0; font-size:12px; opacity:0.7">–í–ê–® –•–û–î:</p>
            <div id="btn-container"></div>
        </div>

        <div style="display:flex; gap:10px">
            <input type="text" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
            <button onclick="sendChat()" style="background:var(--red); border:none; border-radius:12px; width:50px; color:white">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io("–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ù–ê_RENDER"); 
        let isVip = localStorage.getItem('mafia_vip') === 'true';
        let myRole = "";
        let oppName = "";

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∏–∑ –¢–ì
        document.getElementById('name-in').value = tg.initDataUnsafe?.user?.first_name || "";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function findMatch() {
            const name = document.getElementById('name-in').value;
            if(!name) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
            localStorage.setItem('mafia_name', name);
            showScreen('scr-game');
            socket.emit('find_match', { name, isVip });
        }

        function buyVip() {
            tg.showConfirm("–ö—É–ø–∏—Ç—å VIP —Å—Ç–∞—Ç—É—Å?", (ok) => {
                if(ok) {
                    // –ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ç –±—É–¥–µ—Ç Invoice)
                    localStorage.setItem('mafia_vip', 'true');
                    isVip = true;
                    tg.showAlert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω üëë");
                    location.reload();
                }
            });
        }

        socket.on('game_start', (data) => {
            myRole = data.role;
            oppName = data.opponent;
            document.getElementById('my-role').innerText = "–†–û–õ–¨: " + myRole.toUpperCase();
            if(myRole === 'mafia') showActionBtn('kill');
        });

        socket.on('phase_change', (phase) => {
            document.getElementById('game-phase').innerText = phase.toUpperCase();
            document.getElementById('game-phase').style.color = (phase === 'day' ? '#ffcc00' : '#ff3b30');
            if(phase === 'day') showActionBtn('vote');
        });

        socket.on('sys_msg', (msg) => {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="sys">${msg}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        socket.on('chat_msg', (data) => {
            const chat = document.getElementById('chat');
            const cls = data.isVip ? 'vip' : '';
            chat.innerHTML += `<div class="msg ${cls}"><b>${data.user}:</b> ${data.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        socket.on('game_over', (msg) => {
            tg.showAlert(msg);
            location.reload();
        });

        function showActionBtn(type) {
            const box = document.getElementById('action-box');
            const container = document.getElementById('btn-container');
            box.style.display = 'block';
            container.innerHTML = "";

            const b = document.createElement('button');
            b.className = 'btn ' + (type === 'kill' ? 'btn-red' : 'btn-gold');
            b.innerText = type === 'kill' ? `–£–ë–ò–¢–¨ ${oppName}` : `–ì–û–õ–û–°–û–í–ê–¢–¨ –ü–†–û–¢–ò–í ${oppName}`;
            b.onclick = () => {
                socket.emit(type === 'kill' ? 'action' : 'vote', oppName);
                box.style.display = 'none';
            };
            container.appendChild(b);
        }

        function sendChat() {
            const inp = document.getElementById('msg-in');
            if(inp.value) { socket.emit('chat', inp.value); inp.value = ""; }
        }
    </script>
</body>
</html>
