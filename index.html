<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --r: #ff3b30; --g: #ffcc00; --b: #000; }
        body { margin: 0; background: var(--b); color: #fff; font-family: sans-serif; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .active { display: flex; }
        
        .btn { padding: 18px; border-radius: 15px; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .btn-red { background: var(--r); color: #fff; }
        .btn-gold { background: var(--g); color: #000; }
        .btn-glass { background: #1c1c1e; color: #fff; border: 1px solid #333; }

        #chat { flex-grow: 1; overflow-y: auto; background: #111; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #222; }
        input { background: #1c1c1e; border: 1px solid #333; padding: 15px; border-radius: 10px; color: #fff; width: 100%; box-sizing: border-box; }
        
        .match-info { text-align: center; font-size: 24px; margin-top: 40px; color: var(--g); }
    </style>
</head>
<body>

    <div id="scr-menu" class="screen active">
        <h1 style="text-align:center; color:var(--r); font-size:40px; margin:0">MAFIA</h1>
        <p style="text-align:center; opacity:0.5">Stars Edition</p>
        <div style="margin-top:auto">
            <button class="btn btn-red" onclick="startSearch()">–ò–ì–†–ê–¢–¨ (–ü–û–ò–°–ö)</button>
            <button class="btn btn-gold" onclick="showScreen('scr-shop')">–ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
            <button class="btn btn-glass" onclick="showScreen('scr-settings')">–ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="scr-lobby" class="screen">
        <h1>–ü–û–ò–°–ö...</h1>
        <div class="match-info"><span id="q-count">0</span> / 2</div>
        <p style="text-align:center; opacity:0.6">–ñ–¥–µ–º –µ—â–µ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞</p>
        <button class="btn btn-glass" style="margin-top:auto" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="scr-shop" class="screen">
        <h1>SHOP</h1>
        <div style="background:#1c1c1e; padding:20px; border-radius:20px; border:1px solid var(--g); text-align:center">
            <h2 style="color:var(--g)">VIP PASS üëë</h2>
            <p>–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞—Ç—É—Å –∏ –∫–æ—Ä–æ–Ω–∞</p>
            <button class="btn btn-gold" onclick="payStars()">–ö–£–ü–ò–¢–¨ 500 ‚≠ê</button>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="scr-game" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <b id="role-tag" style="color:var(--g)">???</b>
            <b id="phase-tag" style="color:var(--r)">–ù–û–ß–¨</b>
        </div>
        <div id="chat"></div>
        <div id="action-ui" style="display:none">
            <button class="btn btn-red" onclick="socket.emit('night_action', myRoom)">–£–ë–ò–¢–¨</button>
        </div>
        <div style="display:flex; gap:10px">
            <input type="text" id="chat-in" placeholder="–ß–∞—Ç...">
            <button onclick="sendMsg()" style="background:var(--r); border:none; width:60px; border-radius:10px">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io("https://–¢–í–û–ô-–°–ï–†–í–ï–†.render.com"); // –ó–ê–ú–ï–ù–ò–¢–¨
        
        let myName = localStorage.getItem('n') || "Player";
        let isVip = localStorage.getItem('v') === 'true';
        let myRoom = "";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startSearch() {
            showScreen('scr-lobby');
            socket.emit('find_match', { name: myName, isVip: isVip });
        }

        socket.on('queue_update', (count) => {
            document.getElementById('q-count').innerText = count;
        });

        socket.on('match_found', (data) => {
            myRoom = data.room;
            showScreen('scr-game');
            const me = data.players.find(p => p.id === socket.id);
            document.getElementById('role-tag').innerText = "–†–û–õ–¨: " + me.role.toUpperCase();
            if(me.role === 'mafia') document.getElementById('action-ui').style.display = 'block';
        });

        socket.on('phase_day', () => {
            document.getElementById('phase-tag').innerText = "–î–ï–ù–¨";
            document.getElementById('phase-tag').style.color = "var(--g)";
            document.getElementById('action-ui').style.display = 'none';
        });

        socket.on('chat_msg', (d) => {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        function sendMsg() {
            const i = document.getElementById('chat-in');
            if(i.value) {
                socket.emit('send_chat', { roomId: myRoom, name: myName, text: i.value, isVip: isVip });
                i.value = "";
            }
        }

        // –û–ü–õ–ê–¢–ê STARS
        function payStars() {
            // –î–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö Stars –±–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Invoice.
            // –ü–æ–∫–∞ –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –±—ç–∫–µ–Ω–¥–∞ –±–æ—Ç–∞ Invoice –Ω–µ —Å–æ–∑–¥–∞—Ç—å.
            tg.showConfirm("–ö—É–ø–∏—Ç—å VIP –∑–∞ 500 Stars?", (ok) => {
                if(ok) {
                    localStorage.setItem('v', 'true');
                    isVip = true;
                    tg.showAlert("–£—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã VIP.");
                    location.reload();
                }
            });
        }
    </script>
</body>
</html>
