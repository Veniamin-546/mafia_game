<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR PREMIUM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --red: #ff3b30; --gold: #ffcc00; --bg: #050507; --card: #121214; --glass: rgba(255,255,255,0.05); }
        
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        .screen { display: none; height: 100vh; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .active { display: flex; animation: slideUp 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; font-size: 42px; letter-spacing: 6px; color: var(--red); text-shadow: 0 0 20px rgba(255,59,48,0.3); margin: 20px 0; }
        
        .btn { padding: 18px; border-radius: 16px; border: none; font-weight: 800; width: 100%; cursor: pointer; transition: 0.2s; font-size: 14px; text-transform: uppercase; margin-bottom: 12px; }
        .btn-primary { background: var(--red); color: #fff; box-shadow: 0 4px 15px rgba(255,59,48,0.2); }
        .btn-secondary { background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-gold { background: linear-gradient(45deg, #ffcc00, #ff9500); color: #000; }
        
        .card { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        input { background: #000; border: 1px solid #222; padding: 16px; border-radius: 12px; color: #fff; width: 100%; box-sizing: border-box; outline: none; font-size: 16px; }
        input:focus { border-color: var(--red); }

        #chat-area { flex-grow: 1; overflow-y: auto; padding: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 14px; max-width: 85%; padding: 10px 14px; border-radius: 18px; background: var(--glass); align-self: flex-start; }
        .msg.vip { border-left: 3px solid var(--gold); }
        .msg b { color: var(--red); margin-right: 5px; }
        .msg.sys { background: none; color: var(--gold); align-self: center; font-style: italic; font-size: 12px; border: none; }

        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .role-badge { background: var(--glass); padding: 6px 14px; border-radius: 20px; border: 1px solid var(--gold); font-size: 12px; font-weight: bold; color: var(--gold); }
    </style>
</head>
<body>

    <div id="scr-menu" class="screen active">
        <h1>MAFIA</h1>
        <div style="margin-top:auto">
            <button class="btn btn-primary" onclick="showScreen('scr-lobby-find')">–ù–∞–π—Ç–∏ –∏–≥—Ä—É</button>
            <button class="btn btn-secondary" onclick="showScreen('scr-lobby-create')">–°–≤–æ–π –∫–æ–¥</button>
            <button class="btn btn-gold" onclick="showScreen('scr-shop')">–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</button>
            <button class="btn btn-secondary" onclick="showScreen('scr-profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <div id="scr-profile" class="screen">
        <h1>PROFILE</h1>
        <div class="card">
            <label style="font-size:12px; opacity:0.5; margin-left:5px">–í–∞—à –ø—Å–µ–≤–¥–æ–Ω–∏–º</label>
            <input type="text" id="name-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫..." style="margin-top:10px">
            <button class="btn btn-primary" style="margin-top:20px" onclick="saveName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <button class="btn btn-secondary" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-shop" class="screen">
        <h1>SHOP</h1>
        <div class="card" style="border-color: var(--gold); text-align:center">
            <h2 style="color:var(--gold); margin:0">VIP PASS üëë</h2>
            <p style="opacity:0.6; font-size:13px">–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫, –∫–æ—Ä–æ–Ω–∞ –≤ —á–∞—Ç–µ –∏ –æ—Å–æ–±—ã–π —Å—Ç–∞—Ç—É—Å</p>
            <button class="btn btn-gold" onclick="buyVip()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞ 500 ‚≠ê</button>
        </div>
        <button class="btn btn-secondary" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-lobby-create" class="screen">
        <h1>LOBBY</h1>
        <div class="card">
            <input type="text" id="code-input" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä. 777)">
            <button class="btn btn-primary" style="margin-top:15px" onclick="startWithCode()">–°–æ–∑–¥–∞—Ç—å / –í–æ–π—Ç–∏</button>
        </div>
        <button class="btn btn-secondary" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-game" class="screen">
        <div class="game-header">
            <div id="role-display" class="role-badge">–†–û–õ–¨: ???</div>
            <div id="phase-display" style="font-weight:900; color:var(--red)">–ù–û–ß–¨</div>
        </div>
        
        <div id="chat-area"></div>

        <div id="night-controls" class="card" style="display:none; border-color:var(--red)">
            <p style="margin:0 0 10px 0; font-size:12px; opacity:0.7">–ö–æ–≥–æ —É—Å—Ç—Ä–∞–Ω–∏–º?</p>
            <div id="target-btns"></div>
        </div>

        <div style="display:flex; gap:10px; align-items:center">
            <input type="text" id="chat-input" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0; flex-grow:1">
            <button onclick="sendMsg()" style="background:var(--red); border:none; width:50px; height:50px; border-radius:15px; color:#fff">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const socket = io("–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ù–ê_RENDER"); 
        
        let user = {
            name: localStorage.getItem('m_name') || tg.initDataUnsafe?.user?.first_name || "–î–µ—Ç–µ–∫—Ç–∏–≤",
            isVip: localStorage.getItem('m_vip') === 'true'
        };

        document.getElementById('name-input').value = user.name;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-lobby-find') startWithCode('QUICK_MATCH');
        }

        function saveName() {
            user.name = document.getElementById('name-input').value;
            localStorage.setItem('m_name', user.name);
            tg.showAlert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!");
            showScreen('scr-menu');
        }

        function buyVip() {
            tg.showConfirm("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É VIP –∑–∞ 500 Stars?", (ok) => {
                if(ok) {
                    localStorage.setItem('m_vip', 'true');
                    user.isVip = true;
                    location.reload();
                }
            });
        }

        function startWithCode(customCode) {
            const code = customCode || document.getElementById('code-input').value || "1234";
            showScreen('scr-game');
            socket.emit('join_game', { name: user.name, isVip: user.isVip, code: code });
        }

        socket.on('game_init', (data) => {
            document.getElementById('role-display').innerText = "–†–û–õ–¨: " + data.role.toUpperCase();
            if(data.role === 'mafia') {
                const btns = document.getElementById('target-btns');
                btns.innerHTML = "";
                data.opponents.forEach(opp => {
                    btns.innerHTML += `<button class="btn btn-primary" onclick="nightAction()">${opp.name}</button>`;
                });
                document.getElementById('night-controls').style.display = 'block';
            }
        });

        socket.on('phase_change', (data) => {
            document.getElementById('phase-display').innerText = data.phase.toUpperCase();
            document.getElementById('phase-display').style.color = (data.phase === 'day' ? '#ffcc00' : '#ff3b30');
            document.getElementById('night-controls').style.display = 'none';
            addChatMsg(data.msg, true);
        });

        socket.on('sys_msg', (msg) => addChatMsg(msg, true));
        socket.on('new_msg', (data) => addChatMsg(data));

        function addChatMsg(data, isSys = false) {
            const area = document.getElementById('chat-area');
            const div = document.createElement('div');
            if(isSys) {
                div.className = 'msg sys';
                div.innerText = data;
            } else {
                div.className = 'msg' + (data.isVip ? ' vip' : '');
                div.innerHTML = `<b>${data.user}:</b> ${data.text}`;
            }
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function nightAction() {
            socket.emit('execute_night_action');
            document.getElementById('night-controls').style.display = 'none';
        }

        function sendMsg() {
            const inp = document.getElementById('chat-input');
            if(inp.value) {
                socket.emit('send_chat', inp.value);
                inp.value = "";
            }
        }
    </script>
</body>
</html>
