<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #050507; --accent: #ff3b30; --gold: #f1c40f; --text: #fff; --glass: rgba(255,255,255,0.05); }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; width: 100%; margin-bottom: 10px; cursor: pointer; }
        .btn-main { background: var(--accent); color: #fff; }
        .btn-glass { background: var(--glass); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-gold { background: var(--gold); color: #000; }
        #game-chat { flex-grow: 1; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--glass); }
        .msg { font-size: 14px; margin-bottom: 5px; }
        .msg.sys { color: var(--gold); font-style: italic; }
        .vip-name { color: var(--gold); font-weight: bold; }
        input { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: #fff; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1 id="lang-title" style="text-align:center; letter-spacing:5px">MAFIA</h1>
        <div style="margin-top:auto">
            <button class="btn btn-main" onclick="startConnect('online')" id="btn-quick">–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</button>
            <button class="btn btn-glass" onclick="showScreen('screen-setup')" id="btn-create">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button class="btn btn-gold" onclick="showScreen('screen-shop')" id="btn-shop">–ú–ê–ì–ê–ó–ò–ù ‚≠ê</button>
            <button class="btn btn-glass" onclick="showScreen('screen-settings')" id="btn-settings">–ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2 id="set-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <input type="text" id="username-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <p id="set-lang-text">–Ø–∑—ã–∫ / Language:</p>
        <div style="display:flex; gap:10px">
            <button class="btn btn-glass" onclick="setLanguage('ru')">üá∑üá∫ RU</button>
            <button class="btn btn-glass" onclick="setLanguage('en')">üá∫üá∏ EN</button>
        </div>
        <button class="btn btn-main" style="margin-top:auto" onclick="saveSettings()">OK</button>
    </div>

    <div id="screen-shop" class="screen">
        <h2 id="shop-header">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div style="background:var(--glass); padding:15px; border-radius:15px; border:1px solid var(--gold)">
            <b style="color:var(--gold)">VIP STATUS üëë</b>
            <p id="shop-vip-desc" style="font-size:12px">–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫ + –ö–æ—Ä–æ–Ω–∞ + –®–∞–Ω—Å —Ä–æ–ª–∏</p>
            <button class="btn btn-gold" onclick="processPayment('vip')">500 ‚≠ê</button>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h1 id="display-code" style="text-align:center; color:var(--gold)">----</h1>
        <h2 id="lobby-count" style="text-align:center">1 / 2</h2>
        <button class="btn btn-glass" style="margin-top:auto" onclick="location.reload()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; font-size:12px">
            <b id="role-tag" style="color:var(--gold)">–†–û–õ–¨: ???</b>
            <b id="phase-tag" style="color:var(--accent)">–ù–û–ß–¨</b>
        </div>
        <div id="action-pannel" style="background:var(--glass); padding:10px; border-radius:10px; margin:10px 0">
            <small id="action-hint">–í–∞—à —Ö–æ–¥:</small>
            <div id="action-list"></div>
        </div>
        <div id="game-chat"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="msg-input" placeholder="..." style="margin:0">
            <button class="btn-main" style="width:60px; margin:0" onclick="sendMsg()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SERVER_URL = "https://mafia-game-skw7.onrender.com"; 
        let socket, myRole = "", isVip = localStorage.getItem('v') === 'y';
        let lang = localStorage.getItem('l') || 'ru';

        const dict = {
            ru: { quick: "–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞", create: "–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏", shop: "–ú–ê–ì–ê–ó–ò–ù ‚≠ê", settings: "–ù–ê–°–¢–†–û–ô–ö–ò", night_start: "üåô –ù–æ—á—å: –ì–æ—Ä–æ–¥ –∑–∞—Å—ã–ø–∞–µ—Ç...", day_start: "‚òÄÔ∏è –£—Ç—Ä–æ: –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Å—É–∂–¥–µ–Ω–∏–µ!", action_stealth: "üåë –ö—Ç–æ-—Ç–æ —Å–∫—Ä—ã–ª—Å—è –≤ —Ç–µ–Ω–∏...", mafia: "–ú–ê–§–ò–Ø", citizen: "–ú–ò–†–ù–´–ô" },
            en: { quick: "Quick Play", create: "Create Lobby", shop: "SHOP ‚≠ê", settings: "SETTINGS", night_start: "üåô Night: City falls asleep...", day_start: "‚òÄÔ∏è Morning: Start discussion!", action_stealth: "üåë Someone hid in the shadows...", mafia: "MAFIA", citizen: "CITIZEN" }
        };

        function setLanguage(l) { lang = l; localStorage.setItem('l', l); applyLang(); }
        function applyLang() {
            document.getElementById('btn-quick').innerText = dict[lang].quick;
            document.getElementById('btn-create').innerText = dict[lang].create;
            document.getElementById('btn-shop').innerText = dict[lang].shop;
            document.getElementById('btn-settings').innerText = dict[lang].settings;
        }
        applyLang();

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        function saveSettings() {
            localStorage.setItem('n', document.getElementById('username-input').value);
            showScreen('screen-menu');
        }

        function processPayment(item) {
            tg.showConfirm(lang === 'ru' ? "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É?" : "Confirm payment?", (ok) => {
                if(ok) {
                    tg.showAlert(lang === 'ru' ? "–°—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç–æ–º –≤ –õ–°!" : "Invoice sent by bot!");
                    if(item === 'vip') { isVip = true; localStorage.setItem('v', 'y'); }
                }
            });
        }

        function startConnect(mode, limit = 2) {
            showScreen('screen-lobby');
            socket = io(SERVER_URL);
            socket.on('connect', () => {
                socket.emit('join_room', { limit, name: localStorage.getItem('n'), isVip });
            });
            socket.on('update_lobby', data => {
                document.getElementById('display-code').innerText = data.roomId;
                document.getElementById('lobby-count').innerText = `${data.playersCount} / ${data.limit}`;
            });
            socket.on('start_game', data => {
                showScreen('screen-game');
                myRole = data.role;
                document.getElementById('role-tag').innerText = "ROLE: " + data.role.toUpperCase();
                renderActions(data.playersList);
            });
            socket.on('phase_change', data => {
                document.getElementById('phase-tag').innerText = data.phase.toUpperCase();
                document.getElementById('game-chat').innerHTML += `<div class="msg sys">${dict[lang][data.text] || data.text}</div>`;
            });
            socket.on('chat_event', data => {
                let text = data.text;
                if(data.type === 'sys') text = dict[lang][text] || text;
                if(text.includes('check_res')) {
                    let parts = text.split('|');
                    text = `${parts[1]} = ${dict[lang][parts[2]]}`;
                }
                const m = document.createElement('div');
                m.className = data.type === 'sys' ? 'msg sys' : 'msg';
                m.innerHTML = data.type === 'sys' ? `‚Ä¢ ${text}` : `<b class="${data.isVip?'vip-name':''}">${data.user}:</b> ${text}`;
                document.getElementById('game-chat').appendChild(m);
                document.getElementById('game-chat').scrollTop = 9999;
            });
        }

        function renderActions(players) {
            const list = document.getElementById('action-list');
            list.innerHTML = "";
            if(myRole === 'citizen') { document.getElementById('action-pannel').style.display='none'; return; }
            players.forEach(p => {
                if(p.name !== localStorage.getItem('n'))
                    list.innerHTML += `<button class="btn btn-glass" style="padding:5px; font-size:10px" onclick="sendAct('act','${p.id}','${p.name}')">${p.name}</button>`;
            });
            if(myRole === 'mafia') list.innerHTML += `<button class="btn btn-main" onclick="sendAct('hide','','')">HIDE</button>`;
        }

        function sendAct(a, id, n) {
            socket.emit('game_action', { action: a, target: id, targetName: n });
            document.getElementById('action-pannel').style.display = 'none';
        }

        function sendMsg() {
            const i = document.getElementById('msg-input');
            if(i.value) socket.emit('chat', { text: i.value });
            i.value = "";
        }
    </script>
</body>
</html>
