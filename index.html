<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --red: #ff3b30; --gold: #ffcc00; --bg: #0a0a0b; --card: #151517; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        
        h1 { text-align: center; color: var(--red); letter-spacing: 4px; margin-bottom: 30px; }
        .btn { padding: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 12px; text-transform: uppercase; font-size: 13px; }
        .btn-main { background: var(--red); color: white; }
        .btn-glass { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-gold { background: linear-gradient(45deg, #ffcc00, #ff9500); color: black; }
        
        input { background: var(--card); border: 1px solid #222; padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; outline: none; }
        #chat { flex-grow: 1; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 15px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #222; }
        .msg { margin-bottom: 8px; font-size: 14px; }
        .sys { color: var(--gold); text-align: center; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="scr-menu" class="screen active">
        <h1>MAFIA NOIR</h1>
        <div style="margin-top:auto">
            <button class="btn btn-main" onclick="join('quick')">–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</button>
            <button class="btn btn-glass" onclick="showScreen('scr-lobby-create')">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button class="btn btn-gold" onclick="showScreen('scr-shop')">–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</button>
            <button class="btn btn-glass" onclick="showScreen('scr-settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è</button>
        </div>
    </div>

    <div id="scr-lobby-create" class="screen">
        <h1>–õ–û–ë–ë–ò</h1>
        <input type="text" id="lobby-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 777)">
        <button class="btn btn-main" onclick="join('private')">–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</button>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-shop" class="screen">
        <h1>SHOP</h1>
        <div style="background:var(--card); padding:20px; border-radius:20px; text-align:center; border: 1px solid var(--gold)">
            <h3 style="color:var(--gold)">VIP –°–¢–ê–¢–£–° üëë</h3>
            <p style="opacity:0.6">–ö–æ—Ä–æ–Ω–∞ –≤ —á–∞—Ç–µ –∏ –∑–æ–ª–æ—Ç–æ–π –Ω–∏–∫</p>
            <button class="btn btn-gold" style="width:100%" onclick="pay()">500 ‚≠ê / STARS</button>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-settings" class="screen">
        <h1>PROFILE</h1>
        <input type="text" id="name-in" placeholder="–í–∞—à –Ω–∏–∫...">
        <button class="btn btn-main" onclick="saveName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('scr-menu')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="scr-game" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px">
            <b id="role-tag" style="color:var(--gold)">???</b>
            <b id="phase-tag" style="color:var(--red)">–ù–û–ß–¨</b>
        </div>
        <div id="chat"></div>
        <div id="actions" style="display:none; background:var(--card); padding:10px; border-radius:15px; margin-bottom:15px">
            <div id="target-list"></div>
        </div>
        <div style="display:flex; gap:10px">
            <input type="text" id="msg-in" placeholder="..." style="margin:0; flex-grow:1">
            <button onclick="send()" style="background:var(--red); border:none; width:50px; border-radius:12px; color:white">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io("–¢–í–û–Ø_–°–°–´–õ–ö–ê_–ù–ê_RENDER");
        let isVip = localStorage.getItem('v') === 'true';
        let myName = localStorage.getItem('n') || tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
        let myRole = "";

        document.getElementById('name-in').value = myName;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function saveName() {
            myName = document.getElementById('name-in').value;
            localStorage.setItem('n', myName);
            tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            showScreen('scr-menu');
        }

        function pay() {
            tg.showConfirm("–ö—É–ø–∏—Ç—å VIP?", (ok) => {
                if(ok) { localStorage.setItem('v', 'true'); isVip = true; location.reload(); }
            });
        }

        function join(mode) {
            const code = document.getElementById('lobby-code').value;
            showScreen('scr-game');
            socket.emit('join_room', { name: myName, isVip, mode, code });
        }

        socket.on('game_start', (d) => {
            myRole = d.role;
            document.getElementById('role-tag').innerText = d.role.toUpperCase();
            if(myRole === 'mafia') renderActions(d.players);
        });

        socket.on('phase_change', (p) => {
            document.getElementById('phase-tag').innerText = p.toUpperCase();
            document.getElementById('phase-tag').style.color = p === 'day' ? '#ffcc00' : '#ff3b30';
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="sys">‚òÄÔ∏è –£—Ç—Ä–æ! –û–±—Å—É–¥–∏—Ç–µ –∏ –ø—Ä–æ–≥–æ–ª–æ—Å—É–π—Ç–µ –∑–∞ –º–∞—Ñ–∏—é.</div>`;
            renderActions([]); // –í —Ç–µ—Å—Ç–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç
        });

        socket.on('chat_msg', (d) => {
            const chat = document.getElementById('chat');
            chat.innerHTML += `<div class="msg"><b style="color:${d.isVip?'#ffcc00':'#ff3b30'}">${d.user}:</b> ${d.text}</div>`;
            chat.scrollTop = chat.scrollHeight;
        });

        function renderActions(players) {
            const act = document.getElementById('actions');
            const list = document.getElementById('target-list');
            act.style.display = 'block';
            list.innerHTML = "";
            players.forEach(p => {
                if(p.name !== myName) {
                    list.innerHTML += `<button class="btn btn-main" style="width:100%" onclick="doAct('${p.id}')">–£–ë–ò–¢–¨ ${p.name}</button>`;
                }
            });
        }

        function doAct(id) {
            socket.emit('game_action', id);
            document.getElementById('actions').style.display = 'none';
        }

        function send() {
            const i = document.getElementById('msg-in');
            if(i.value) { socket.emit('chat', i.value); i.value = ""; }
        }
    </script>
</body>
</html>
