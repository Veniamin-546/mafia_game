<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mafia Real-Time</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root { --bg: #0a0a0c; --card: #16161a; --accent: #ff3b30; --gold: #f1c40f; --text: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .btn { padding: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; text-transform: uppercase; }
        .btn-main { background: var(--accent); color: white; }
        .btn-dark { background: var(--card); color: white; border: 1px solid #333; }
        .radar { width: 100px; height: 100px; border: 3px solid var(--accent); border-radius: 50%; margin: 40px auto; position: relative; }
        .radar::after { content: ''; position: absolute; width: 100%; height: 100%; border: 2px solid var(--accent); border-radius: 50%; animation: p 2s infinite; }
        @keyframes p { 0% {transform: scale(1); opacity: 1;} 100% {transform: scale(1.5); opacity: 0;} }
        #chat-area { flex-grow: 1; background: var(--card); border-radius: 15px; padding: 15px; overflow-y: auto; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <h1 style="text-align:center; color:var(--accent); font-size:40px;">MAFIA</h1>
        <button class="btn btn-main" onclick="joinQueue('online')">Играть Онлайн</button>
        <button class="btn btn-dark" onclick="showScreen('screen-local')">Локальная группа</button>
    </div>

    <div id="screen-local" class="screen">
        <h2>Количество игроков:</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn-dark" style="flex:1" onclick="joinQueue('local', 5)">5</button>
            <button class="btn-dark" style="flex:1" onclick="joinQueue('local', 10)">10</button>
        </div>
        <button class="btn-dark" onclick="showScreen('screen-menu')">Назад</button>
    </div>

    <div id="screen-loading" class="screen" style="text-align:center;">
        <div class="radar"></div>
        <h2 id="status">ПОИСК СЕРВЕРА...</h2>
        <p id="count-label">Ожидание игроков: 1 / --</p>
        <button class="btn btn-dark" onclick="cancelAll()">Отмена</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-info" style="color:var(--gold); margin-bottom:10px;">РОЛЬ: ???</div>
        <div id="chat-area"></div>
        <input type="text" id="msg-input" placeholder="Сообщение..." style="padding:15px; border-radius:10px; border:none; background:#222; color:white;">
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // !!! ЗАМЕНИ ЭТОТ URL НА АДРЕС СВОЕГО СЕРВЕРА (например, от Ngrok или Render)
        const SERVER_URL = "https://your-backend-address.com"; 
        let socket;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function joinQueue(mode, limit = 10) {
            showScreen('screen-loading');
            
            // Подключаемся к сокету
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                document.getElementById('status').innerText = "В ОЧЕРЕДИ...";
                // Передаем данные серверу
                socket.emit('join_queue', {
                    name: tg.initDataUnsafe.user?.first_name || "Игрок",
                    mode: mode,
                    limit: limit
                });
            });

            // СЛУШАЕМ СЕРВЕР: Обновление количества людей
            socket.on('update_count', (data) => {
                document.getElementById('count-label').innerText = `Найдено: ${data.current} / ${data.total}`;
            });

            // СЛУШАЕМ СЕРВЕР: Старт игры
            socket.on('game_start', (data) => {
                showScreen('screen-game');
                document.getElementById('game-info').innerText = "ВАША РОЛЬ: " + data.role;
                tg.HapticFeedback.notificationOccurred('success');
            });

            socket.on('connect_error', () => {
                document.getElementById('status').innerText = "ОШИБКА СЕРВЕРА";
            });
        }

        function cancelAll() {
            if(socket) socket.disconnect();
            showScreen('screen-menu');
        }
    </script>
</body>
</html>
