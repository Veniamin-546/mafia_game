<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA NOIR ULTIMATE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #050507; --accent: #ff3b30; --gold: #f1c40f;
            --text: #ffffff; --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; height: 100vh;
            background: radial-gradient(circle at 50% 100%, #1a0505 0%, #050507 100%);
        }

        .screen { display: none; height: 100vh; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .active { display: flex; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .header h1 { font-size: 38px; letter-spacing: 8px; color: var(--accent); margin: 0; text-align: center; text-shadow: 0 0 15px rgba(255,59,48,0.5); }
        .btn {
            padding: 16px; border-radius: 14px; border: none; font-size: 13px; font-weight: 800;
            text-transform: uppercase; cursor: pointer; transition: 0.2s; width: 100%; margin-bottom: 12px;
        }
        .btn-main { background: linear-gradient(135deg, #ff3b30 0%, #8b0000 100%); color: white; }
        .btn-glass { background: var(--glass); border: 1px solid var(--glass-border); color: white; backdrop-filter: blur(10px); }
        .btn-gold { background: linear-gradient(135deg, #f1c40f 0%, #996600 100%); color: black; }

        /* –ú–∞–≥–∞–∑–∏–Ω –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .card { background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 18px; margin-bottom: 15px; }
        .vip-text { color: var(--gold); font-weight: bold; text-shadow: 0 0 8px rgba(241,196,15,0.4); }
        input { background: var(--glass); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 20px; outline: none; }

        /* –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç */
        #game-chat { flex-grow: 1; background: rgba(0,0,0,0.4); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--glass-border); overflow-y: auto; }
        .msg { margin-bottom: 8px; font-size: 14px; line-height: 1.4; }
        .msg b { color: var(--accent); }
        .msg.sys { color: var(--gold); font-style: italic; opacity: 0.9; border-left: 2px solid var(--gold); padding-left: 10px; }
        .vip-msg b { color: var(--gold) !important; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="header"><h1>MAFIA</h1><p style="text-align:center; letter-spacing:3px; font-size:10px; opacity:0.6">PREMIUM EDITION</p></div>
        <div style="margin-top: auto;">
            <button class="btn btn-main" onclick="startConnect('online')">üé≠ –ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞</button>
            <button class="btn btn-glass" onclick="showScreen('screen-setup')">üë• –°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button class="btn btn-glass" onclick="showScreen('screen-join')">üîë –í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</button>
            <button class="btn btn-gold" onclick="showScreen('screen-shop')">üëë –ú–ê–ì–ê–ó–ò–ù</button>
            <button class="btn btn-glass" onclick="showScreen('screen-settings')">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <label>–í–∞—à –Ω–∏–∫–Ω–µ–π–º:</label>
        <input type="text" id="username-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è...">
        <label>–Ø–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</label>
        <button class="btn btn-glass">üá∑üá∫ –†–£–°–°–ö–ò–ô</button>
        <button class="btn btn-main" style="margin-top:auto" onclick="saveSettings()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="screen-shop" class="screen">
        <h2>–ú–ê–ì–ê–ó–ò–ù ‚≠ê</h2>
        <div class="card">
            <b class="vip-text">VIP –°–¢–ê–¢–£–° üëë</b>
            <p style="font-size:11px; opacity:0.8">–ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫, –∫–æ—Ä–æ–Ω–∞ –≤ —á–∞—Ç–µ –∏ +10% –∫ —à–∞–Ω—Å—É –ú–∞—Ñ–∏–∏.</p>
            <button class="btn btn-gold" style="margin:0; padding:10px" onclick="buy('vip')">–ö–£–ü–ò–¢–¨ (500 ‚≠ê)</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
            <div class="card" style="margin:0; text-align:center">
                <b style="font-size:10px">–®–ê–ù–° –ú–ê–§–ò–ò X2</b>
                <button class="btn btn-main" style="margin:10px 0 0 0; padding:8px" onclick="buy('mafia_boost')">150 ‚≠ê</button>
            </div>
            <div class="card" style="margin:0; text-align:center">
                <b style="font-size:10px">–®–ê–ù–° –ö–û–ú–ò–°–°–ê–†–ê</b>
                <button class="btn btn-glass" style="margin:10px 0 0 0; border-color:var(--gold); padding:8px" onclick="buy('com_boost')">100 ‚≠ê</button>
            </div>
        </div>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-setup" class="screen">
        <h2>–°–û–ó–î–ê–¢–¨ –ò–ì–†–£</h2>
        <button class="btn btn-gold" onclick="startConnect('local', 2)">üöÄ –¢–ï–°–¢ (2 –ò–ì–†–û–ö–ê)</button>
        <button class="btn btn-glass" onclick="startConnect('local', 5)">5 –ò–ì–†–û–ö–û–í</button>
        <button class="btn btn-glass" onclick="startConnect('local', 10)">10 –ò–ì–†–û–ö–û–í</button>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-join" class="screen">
        <h2>–í–•–û–î –ü–û –ö–û–î–£</h2>
        <input type="number" id="input-code" placeholder="0000" style="text-align:center; font-size:24px">
        <button class="btn btn-main" onclick="startConnect('join')">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        <button class="btn btn-glass" style="margin-top:auto" onclick="showScreen('screen-menu')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h1 id="display-code" style="text-align:center; color:var(--gold); font-size:45px; margin:20px 0">----</h1>
        <div style="text-align:center; flex-grow:1">
            <p id="lobby-status">–ü–û–ò–°–ö –ò–ì–†–û–ö–û–í...</p>
            <h2 id="lobby-count">1 / 2</h2>
        </div>
        <button class="btn btn-glass" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <span id="role-tag" class="vip-text" style="font-size:12px">–†–û–õ–¨: ???</span>
            <span id="phase-tag" style="color:var(--accent); font-weight:bold">–ù–û–ß–¨ 1</span>
        </div>

        <div id="action-pannel" class="card" style="border-color:var(--accent)">
            <p id="action-hint" style="margin:0 0 10px 0; font-size:12px">–í–ê–® –•–û–î:</p>
            <div id="action-list"></div>
        </div>

        <div id="game-chat"></div>

        <div style="display:flex; gap:8px">
            <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." style="margin:0">
            <button class="btn-main" style="width:60px; border-radius:12px" onclick="sendMsg()">üì°</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SERVER_URL = "https://mafia-game-skw7.onrender.com"; // –¢–í–û–Ø –°–°–´–õ–ö–ê
        let socket;
        let myName = localStorage.getItem('mafia_name') || tg.initDataUnsafe.user?.first_name || "–ò–≥—Ä–æ–∫";
        let isVip = localStorage.getItem('mafia_vip') === 'true';
        let myRole = "";
        let canSelfHeal = true;

        document.getElementById('username-input').value = myName;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function saveSettings() {
            myName = document.getElementById('username-input').value;
            localStorage.setItem('mafia_name', myName);
            showScreen('screen-menu');
        }

        function buy(item) {
            tg.showConfirm(`–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ü–û–ö–£–ü–ö–£?`, (ok) => {
                if(ok) {
                    if(item === 'vip') {
                        isVip = true;
                        localStorage.setItem('mafia_vip', 'true');
                        tg.showAlert("–ö–û–†–û–ù–ê –í–ê–®–ê! üëë");
                    } else {
                        tg.showAlert("–®–ê–ù–° –£–í–ï–õ–ò–ß–ï–ù!");
                    }
                }
            });
        }

        function startConnect(mode, limit = 2) {
            const code = document.getElementById('input-code').value;
            showScreen('screen-lobby');

            socket = io(SERVER_URL);

            socket.on('connect', () => {
                socket.emit('join_room', { mode, limit, code, name: myName, isVip: isVip });
            });

            socket.on('update_lobby', (data) => {
                document.getElementById('display-code').innerText = data.roomId;
                document.getElementById('lobby-count').innerText = `${data.playersCount} / ${data.limit}`;
            });

            socket.on('start_game', (data) => {
                showScreen('screen-game');
                myRole = data.role;
                document.getElementById('role-tag').innerText = "–†–û–õ–¨: " + myRole.toUpperCase();
                
                if(myRole === 'citizen') {
                    document.getElementById('action-pannel').style.display = 'none';
                } else {
                    renderActions(data.playersList);
                }
            });

            socket.on('chat_event', (data) => {
                const chat = document.getElementById('game-chat');
                const m = document.createElement('div');
                m.className = data.isVip ? 'msg vip-msg' : 'msg';
                if(data.type === 'sys') m.className = 'msg sys';

                m.innerHTML = data.type === 'sys' ? data.text : `<b>${data.user}:</b> ${data.text}`;
                chat.appendChild(m);
                chat.scrollTop = chat.scrollHeight;
            });
        }

        function renderActions(players) {
            const list = document.getElementById('action-list');
            list.innerHTML = "";
            
            if (myRole === 'mafia') {
                players.forEach(p => {
                    if(p.name !== myName) {
                        list.innerHTML += `<button class="btn btn-main" style="padding:10px; font-size:10px" onclick="sendAction('kill', '${p.id}', '${p.name}')">–£–ë–ò–¢–¨: ${p.name}</button>`;
                    }
                });
                list.innerHTML += `<button class="btn btn-glass" style="padding:10px; font-size:10px" onclick="sendAction('hide', null, '')">–°–ö–†–´–¢–¨–°–Ø (–ü–†–û–ü–£–°–¢–ò–¢–¨)</button>`;
            } 
            
            else if (myRole === 'doctor') {
                players.forEach(p => {
                    if(p.name === myName && !canSelfHeal) return;
                    list.innerHTML += `<button class="btn btn-gold" style="padding:10px; font-size:10px" onclick="sendAction('heal', '${p.id}', '${p.name}')">–õ–ï–ß–ò–¢–¨: ${p.name}</button>`;
                });
            }

            else if (myRole === 'comisar') {
                players.forEach(p => {
                    if(p.name !== myName) {
                        list.innerHTML += `
                        <div style="display:flex; gap:5px; margin-bottom:5px">
                            <button class="btn btn-glass" style="flex:1; padding:10px; font-size:9px" onclick="sendAction('check', '${p.id}', '${p.name}')">üîç –ü–†–û–í–ï–†–ò–¢–¨</button>
                            <button class="btn btn-main" style="flex:1; padding:10px; font-size:9px; background:#400" onclick="sendAction('shoot', '${p.id}', '${p.name}')">üî´ –í–´–°–¢–†–ï–õ</button>
                        </div>`;
                    }
                });
            }
        }

        function sendAction(type, targetId, targetName) {
            if(type === 'heal' && targetName === myName) canSelfHeal = false;
            socket.emit('game_action', { action: type, target: targetId, targetName: targetName });
            document.getElementById('action-pannel').style.display = 'none';
            tg.HapticFeedback.notificationOccurred('success');
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(!inp.value) return;
            socket.emit('chat', { text: inp.value });
            inp.value = "";
        }
    </script>
</body>
</html>
